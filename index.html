<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tematické degustace vín - Amantes Vinea Club</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tasting-card { transition: transform 0.3s ease, box-shadow 0.3s ease; border-radius: 0.75rem; }
        .tasting-card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .schedule-status-required { color: #b91c1c; font-weight: 600; }
        .schedule-status-optional { color: #059669; font-weight: 600; }
        .detail-item { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .detail-item svg { color: #b91c1c; margin-right: 0.5rem; width: 1.25rem; height: 1.25rem; }
        .variety-info { background-color: #fff7ed; border-left: 4px solid #ea580c; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #b91c1c; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #error-message { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-12 max-w-6xl">
        
        <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
            <strong class="font-bold">Chyba!</strong>
            <span class="block sm:inline" id="error-text"></span>
        </div>

        <!-- HLAVNÍ STRÁNKA -->
        <div id="home">
            <header class="text-center mb-16 pt-8">
                <img src="amantes_vinea_logo.png" alt="Logo klubu Amantes Vinea" class="h-28 mx-auto mb-6 drop-shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/250x110/374151/ffffff?text=Amantes+Vinea';">
                <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 mb-4 tracking-tight">Tematické degustace</h1>
                <p class="text-xl text-gray-600 italic">Výjimečné termíny. Pouze pro členy klubu.</p>
            </header>
            
            <div id="home-loader" class="loader hidden"></div>
            <main id="tasting-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10"></main>
        </div>

        <!-- DETAILNÍ STRÁNKA -->
        <div id="detail" class="hidden">
            <header class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <button id="back-button" class="bg-gray-800 text-white py-2 px-5 rounded-xl hover:bg-gray-700 transition-colors text-lg font-semibold shadow-lg">
                    &larr; Zpět na přehled
                </button>
                <h1 id="detail-title" class="text-3xl md:text-4xl font-bold text-gray-900 text-right flex-1"></h1>
            </header>

            <div id="variety-info-container" class="mb-8 hidden"></div>

            <div class="mb-6 flex justify-end">
                <button id="toggle-add-wine-btn" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow transition flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Přidat vlastní vzorek
                </button>
                <p id="add-wine-closed-msg" class="hidden text-red-600 font-bold bg-red-50 border border-red-200 px-4 py-2 rounded-lg">
                    ⚠️ Příjem vzorků do této degustace byl již ukončen.
                </p>
            </div>

            <div id="add-wine-container" class="hidden bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 border-b pb-4">
                    <h3 class="text-xl font-bold text-gray-900 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Nové víno
                    </h3>
                </div>

                <form id="add-wine-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="input-name" placeholder="Název vína (např. Kerner 2024)" class="border p-3 rounded-lg w-full transition-colors focus:ring-2 focus:ring-red-500 outline-none" required>
                    <input type="text" id="input-winery" placeholder="Vinařství" class="border p-3 rounded-lg w-full transition-colors focus:ring-2 focus:ring-red-500 outline-none" required>
                    
                    <select id="input-classification" class="border p-3 rounded-lg w-full transition-colors focus:ring-2 focus:ring-red-500 outline-none">
                        <option value="">-- Klasifikace --</option>
                        <option value="Moravské zemské víno">Moravské zemské víno</option>
                        <option value="Pozdní sběr">Pozdní sběr</option>
                        <option value="Výběr z hroznů">Výběr z hroznů</option>
                        <option value="Výběr z bobulí">Výběr z bobulí</option>
                        <option value="Kabinetní víno">Kabinetní víno</option>
                        <option value="Jakostní víno">Jakostní víno</option>
                        <option value="VOC">VOC</option>
                        <option value="Likérové víno">Likérové víno</option>
                        <option value="Slámové víno">Slámové víno</option>
                        <option value="Ledové víno">Ledové víno</option>
                    </select>

                    <select id="input-sweetness" class="border p-3 rounded-lg w-full transition-colors focus:ring-2 focus:ring-red-500 outline-none">
                        <option value="">-- Cukernatost --</option>
                        <option value="Suché">Suché</option>
                        <option value="Polosuché">Polosuché</option>
                        <option value="Polosladké">Polosladké</option>
                        <option value="Sladké">Sladké</option>
                    </select>

                    <input type="text" id="input-alcohol" placeholder="Alkohol (např. 12,5 %)" class="border p-3 rounded-lg w-full transition-colors focus:ring-2 focus:ring-red-500 outline-none">
                    <input type="text" id="input-origin" placeholder="Původ (podoblast, obec)" class="border p-3 rounded-lg w-full transition-colors focus:ring-2 focus:ring-red-500 outline-none">
                    
                    <div class="md:col-span-2">
                        <textarea id="input-pairing" placeholder="Párování s jídlem nebo poznámka" class="border p-3 rounded-lg w-full h-20 transition-colors focus:ring-2 focus:ring-red-500 outline-none"></textarea>
                    </div>

                    <div class="md:col-span-2">
                        <button type="submit" class="bg-red-700 text-white font-bold py-3 px-6 rounded-lg w-full hover:bg-red-800 transition shadow-md">
                            Uložit víno do databáze
                        </button>
                    </div>
                </form>
            </div>
            
            <div id="wine-loader" class="loader hidden"></div>
            <main id="wine-list" class="space-y-6"></main>
        </div>
    </div>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Konfigurace Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAn6jNCHyJNo194jOPMrate3vQ-sBQdsrk",
            authDomain: "amantesvinea.firebaseapp.com",
            databaseURL: "https://amantesvinea-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "amantesvinea",
            storageBucket: "amantesvinea.firebasestorage.app",
            messagingSenderId: "314403202533",
            appId: "1:314403202533:web:db9eb6416a8710a837bb0c"
        };

        let app, db;

        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
        } catch (e) {
            showError("Chyba inicializace Firebase: " + e.message);
        }

        let currentTastingId = null;
        
        // Elementy
        const homePage = document.getElementById('home');
        const detailPage = document.getElementById('detail');
        const tastingListContainer = document.getElementById('tasting-list');
        const wineListContainer = document.getElementById('wine-list');
        const detailTitle = document.getElementById('detail-title');
        const varietyInfoContainer = document.getElementById('variety-info-container');
        const homeLoader = document.getElementById('home-loader');
        const wineLoader = document.getElementById('wine-loader');
        const errorMsg = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        const toggleAddWineBtn = document.getElementById('toggle-add-wine-btn');
        const addWineClosedMsg = document.getElementById('add-wine-closed-msg');
        const addWineContainer = document.getElementById('add-wine-container');

        function showError(msg) {
            errorText.innerText = msg;
            errorMsg.style.display = 'block';
            console.error(msg);
            setTimeout(() => { errorMsg.style.display = 'none'; }, 6000);
        }

        // --- Zbytek logiky (Firebase, UI) ---

        function isRegistrationOpen(dateString) {
            const eventDate = new Date(dateString);
            eventDate.setHours(0, 0, 0, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return today < eventDate;
        }

        toggleAddWineBtn.addEventListener('click', () => {
            if (addWineContainer.classList.contains('hidden')) {
                addWineContainer.classList.remove('hidden');
                toggleAddWineBtn.innerHTML = `Zavřít formulář`;
                toggleAddWineBtn.classList.replace('bg-green-600', 'bg-gray-500');
                toggleAddWineBtn.classList.replace('hover:bg-green-700', 'hover:bg-gray-600');
            } else {
                addWineContainer.classList.add('hidden');
                toggleAddWineBtn.innerHTML = `Přidat vlastní vzorek`;
                toggleAddWineBtn.classList.replace('bg-gray-500', 'bg-green-600');
                toggleAddWineBtn.classList.replace('hover:bg-gray-600', 'hover:bg-green-700');
            }
        });

        function loadTastings() {
            homeLoader.classList.remove('hidden');
            const tastingsRef = ref(db, 'tastings');

            onValue(tastingsRef, (snapshot) => {
                tastingListContainer.innerHTML = '';
                const data = snapshot.val();
                
                if (!data) {
                    tastingListContainer.innerHTML = '<p class="text-center p-4">Žádná data v databázi.</p>';
                    homeLoader.classList.add('hidden');
                    return;
                }

                const tastings = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                tastings.sort((a, b) => new Date(b.date) - new Date(a.date));

                tastings.forEach(tasting => {
                    const dayInfo = getTimeRemaining(tasting.date);
                    const firstTwoWords = tasting.theme.split(' ').slice(0, 2).join('+');
                    const card = document.createElement('div');
                    card.className = "tasting-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer";
                    card.onclick = () => showDetailPage(tasting);
                    card.innerHTML = `
                        <img src="${tasting.image}" alt="${tasting.theme}" class="w-full h-52 object-cover" 
                             onerror="this.onerror=null;this.src='https://placehold.co/600x400/374151/ffffff?text=${firstTwoWords}';">
                        <div class="p-6">
                            <p class="text-sm font-semibold mb-2 ${dayInfo.includes('Probíhá') || dayInfo.includes('Zítra') ? 'text-red-600' : 'text-gray-500'}">
                                ${dayInfo} &middot; ${tasting.displayDate}
                            </p>
                            <h2 class="text-2xl font-bold text-gray-900 mt-1 mb-3">${tasting.theme}</h2>
                            <p class="text-gray-600 mb-5">${tasting.description}</p>
                            <div class="flex justify-between items-center text-sm font-medium border-t pt-4">
                                <span class="text-gray-500">Otevřít degustaci</span>
                                <span class="text-red-700 font-bold hover:text-red-900 transition-colors">&rarr;</span>
                            </div>
                        </div>`;
                    tastingListContainer.appendChild(card);
                });
                homeLoader.classList.add('hidden');
            }, (error) => {
                let msg = "Chyba při načítání dat: " + error.message;
                if (error.code === 'PERMISSION_DENIED') msg = "Přístup odepřen! Nastavte pravidla v konzoli.";
                showError(msg);
                homeLoader.classList.add('hidden');
            });
        }

        window.showDetailPage = function(tasting) {
            currentTastingId = tasting.id;
            detailTitle.textContent = tasting.theme;
            errorMsg.style.display = 'none';
            
            // Logika tlačítek a formuláře
            addWineContainer.classList.add('hidden'); // Vždy schovat formulář při startu
            
            if (isRegistrationOpen(tasting.date)) {
                toggleAddWineBtn.classList.remove('hidden');
                addWineClosedMsg.classList.add('hidden');
                toggleAddWineBtn.innerHTML = "Přidat vlastní vzorek";
                toggleAddWineBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                toggleAddWineBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                toggleAddWineBtn.classList.add('hidden');
                addWineClosedMsg.classList.remove('hidden');
            }

            varietyInfoContainer.innerHTML = '';
            if (tasting.varietyInfo) {
                varietyInfoContainer.classList.remove('hidden');
                let html = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">`;
                tasting.varietyInfo.forEach(info => {
                    html += `<div class="variety-info p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${info.title}</h3>
                        <p class="text-sm text-gray-700 mb-2"><strong>Původ:</strong> ${info.origin}</p>
                        <p class="text-sm text-gray-700"><strong>Charakteristika:</strong> ${info.characteristics}</p>
                    </div>`;
                });
                html += `</div>`;
                varietyInfoContainer.innerHTML = html;
            } else {
                varietyInfoContainer.classList.add('hidden');
            }

            homePage.classList.add('hidden');
            detailPage.classList.remove('hidden');
            window.scrollTo(0, 0);

            wineListContainer.innerHTML = '';
            wineLoader.classList.remove('hidden');

            const winesRef = query(ref(db, 'wines'), orderByChild('tastingId'), equalTo(currentTastingId));

            onValue(winesRef, (snapshot) => {
                wineListContainer.innerHTML = '';
                const data = snapshot.val();

                if (!data) {
                    wineListContainer.innerHTML = `<p class="text-center text-gray-500 italic p-8">Zatím nebyla přidána žádná vína.</p>`;
                    wineLoader.classList.add('hidden');
                    return;
                }

                const wines = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                wines.sort((a, b) => (a.createdAt || '').localeCompare(b.createdAt || ''));

                let index = 1;
                wines.forEach((wine) => {
                    const wineCard = document.createElement('div');
                    wineCard.className = "bg-white rounded-xl shadow-lg p-6 border-l-8 border-red-700 relative group";
                    wineCard.innerHTML = `
                        <h3 class="text-2xl font-extrabold text-gray-900 mb-3"><span class="text-red-700">${index}.</span> ${wine.name}</h3>
                        <p class="text-lg text-gray-700 font-semibold mb-4">${wine.winery}</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-y-4 gap-x-6 text-sm">
                            <div><p class="text-gray-500">Klasifikace</p><p class="font-bold text-gray-800">${wine.classification || '-'}</p></div>
                            <div><p class="text-gray-500">Cukernatost</p><p class="font-bold text-gray-800">${wine.sweetness || '-'}</p></div>
                            <div><p class="text-gray-500">Alkohol</p><p class="font-bold text-gray-800">${wine.alcohol || '-'}</p></div>
                            <div class="md:col-span-1"><p class="text-gray-500">Původ</p><p class="font-bold text-gray-800">${wine.origin || '-'}</p></div>
                        </div>
                        ${wine.pairing ? `<div class="mt-6 p-4 bg-gray-50 rounded-lg border-l-4 border-gray-300"><p class="text-gray-500 font-medium">Poznámka / Párování</p><p class="font-medium text-gray-800">${wine.pairing}</p></div>` : ''}`;
                    wineListContainer.appendChild(wineCard);
                    index++;
                });
                wineLoader.classList.add('hidden');
            }, (error) => {
                 showError("Chyba při načítání vín: " + error.message);
                 wineLoader.classList.add('hidden');
            });
        }

        document.getElementById('add-wine-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentTastingId) return;

            const submitBtn = e.target.querySelector('button');
            const originalText = submitBtn.innerText;
            submitBtn.innerText = "Ukládám...";
            submitBtn.disabled = true;

            const newWine = {
                tastingId: currentTastingId,
                name: document.getElementById('input-name').value,
                winery: document.getElementById('input-winery').value,
                classification: document.getElementById('input-classification').value,
                sweetness: document.getElementById('input-sweetness').value,
                alcohol: document.getElementById('input-alcohol').value,
                origin: document.getElementById('input-origin').value,
                pairing: document.getElementById('input-pairing').value,
                createdAt: new Date().toISOString()
            };

            const newWineRef = push(ref(db, 'wines'));
            set(newWineRef, newWine)
                .then(() => {
                    e.target.reset();
                    alert("Víno úspěšně přidáno!");
                    addWineContainer.classList.add('hidden');
                    toggleAddWineBtn.innerHTML = `Přidat vlastní vzorek`;
                    toggleAddWineBtn.classList.replace('bg-gray-500', 'bg-green-600');
                    toggleAddWineBtn.classList.replace('hover:bg-gray-600', 'hover:bg-green-700');
                })
                .catch((error) => {
                    showError("Chyba při ukládání: " + error.message);
                })
                .finally(() => {
                    submitBtn.innerText = originalText;
                    submitBtn.disabled = false;
                });
        });

        document.getElementById('back-button').addEventListener('click', () => {
            detailPage.classList.add('hidden');
            homePage.classList.remove('hidden');
            errorMsg.style.display = 'none';
            currentTastingId = null;
        });

        function getTimeRemaining(dateString) {
            const eventDate = new Date(dateString);
            eventDate.setHours(0, 0, 0, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diffTime = eventDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < -3) return 'Proběhlo'; 
            if (diffDays <= 0) return 'Právě probíhá';
            if (diffDays === 1) return 'Zítra!';
            if (diffDays < 7) return `Za ${diffDays} dny`;
            if (diffDays <= 30) return `Za ${diffDays} dní`;
            return `Za ${Math.floor(diffDays / 30)} měsíců`;
        }

        loadTastings();
    </script>
</body>
</html>