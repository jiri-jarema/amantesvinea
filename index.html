<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tematick√© degustace v√≠n - Amantes Vinea Club</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tasting-card { transition: transform 0.3s ease, box-shadow 0.3s ease; border-radius: 0.75rem; }
        .tasting-card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .schedule-status-required { color: #b91c1c; font-weight: 600; }
        .schedule-status-optional { color: #059669; font-weight: 600; }
        .detail-item { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .detail-item svg { color: #b91c1c; margin-right: 0.5rem; width: 1.25rem; height: 1.25rem; }
        .variety-info { background-color: #fff7ed; border-left: 4px solid #ea580c; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #b91c1c; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #error-message { display: none; }
        
        /* Overlay pro skenov√°n√≠ */
        #scan-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; backdrop-filter: blur(5px);
        }
        .scan-scanner {
            width: 80%; max-width: 300px; height: 200px;
            border: 2px solid #ef4444; border-radius: 12px;
            position: relative; overflow: hidden;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            background: rgba(255,255,255,0.05);
        }
        .scan-line {
            width: 100%; height: 2px; background: #ef4444;
            position: absolute; top: 0;
            box-shadow: 0 0 10px #ef4444;
            animation: scan 2s infinite linear;
        }
        @keyframes scan {
            0% { transform: translateY(0); opacity: 0.5; }
            50% { opacity: 1; }
            100% { transform: translateY(200px); opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Overlay pro skenov√°n√≠ (skryt√Ω by default) -->
    <div id="scan-overlay" class="hidden">
        <div class="text-4xl mb-4">ü§ñ</div>
        <div class="text-2xl font-bold mb-8 animate-pulse">Analyzuji etiketu...</div>
        <div class="scan-scanner mb-8">
            <div class="scan-line"></div>
        </div>
        <p class="text-gray-300 text-center px-4">Pros√≠m ƒçekejte, Gemini ƒçte √∫daje z etikety<br>a dohled√°v√° podrobnosti.</p>
    </div>

    <div id="app" class="container mx-auto p-4 md:p-12 max-w-6xl">
        
        <!-- Chybov√Ω box -->
        <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
            <strong class="font-bold">Chyba!</strong>
            <span class="block sm:inline" id="error-text"></span>
        </div>

        <!-- HLAVN√ç STR√ÅNKA -->
        <div id="home">
            <header class="text-center mb-16 pt-8">
                <img src="amantes_vinea_logo.png" alt="Logo klubu Amantes Vinea" class="h-28 mx-auto mb-6 drop-shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/250x110/374151/ffffff?text=Amantes+Vinea';">
                <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 mb-4 tracking-tight">Tematick√© degustace</h1>
                <p class="text-xl text-gray-600 italic">V√Ωjimeƒçn√© term√≠ny. Pouze pro ƒçleny klubu.</p>
            </header>
            
            <div id="home-loader" class="loader hidden"></div>
            <main id="tasting-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10"></main>
        </div>

        <!-- DETAILN√ç STR√ÅNKA -->
        <div id="detail" class="hidden">
            <header class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <button id="back-button" class="bg-gray-800 text-white py-2 px-5 rounded-xl hover:bg-gray-700 transition-colors text-lg font-semibold shadow-lg">
                    &larr; Zpƒõt na p≈ôehled
                </button>
                <h1 id="detail-title" class="text-3xl md:text-4xl font-bold text-gray-900 text-right flex-1"></h1>
            </header>

            <div id="variety-info-container" class="mb-8 hidden"></div>

            <!-- OVL√ÅD√ÅN√ç FORMUL√Å≈òE (Tlaƒç√≠tko / Zpr√°va) -->
            <div class="mb-6 flex justify-end">
                <button id="toggle-add-wine-btn" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow transition flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    P≈ôidat vlastn√≠ vzorek
                </button>
                <p id="add-wine-closed-msg" class="hidden text-red-600 font-bold bg-red-50 border border-red-200 px-4 py-2 rounded-lg">
                    ‚ö†Ô∏è P≈ô√≠jem vzork≈Ø do t√©to degustace byl ji≈æ ukonƒçen.
                </p>
            </div>

            <!-- FORMUL√Å≈ò (Ve v√Ωchoz√≠m stavu skryt√Ω) -->
            <div id="add-wine-container" class="hidden bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 border-b pb-4">
                    <h3 class="text-xl font-bold text-gray-900 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-red-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Nov√© v√≠no
                    </h3>
                    
                    <!-- Tlaƒç√≠tko pro skenov√°n√≠ -->
                    <label class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-4 rounded-lg shadow flex items-center transition transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        üì∑ Naƒç√≠st z fotky etikety
                        <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden">
                    </label>
                </div>

                <form id="add-wine-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-1 md:col-span-2 text-sm text-gray-500 italic mb-2">
                        √ödaje m≈Ø≈æete vyplnit ruƒçnƒõ nebo pou≈æ√≠t tlaƒç√≠tko fotoapar√°tu v√Ω≈°e.
                    </div>

                    <input type="text" id="input-name" placeholder="N√°zev v√≠na (nap≈ô. Kerner 2024)" class="border p-3 rounded-lg w-full transition-colors focus:ring-2 focus:ring-red-500 outline-none" required>
                    <input type="text" id="input-winery" placeholder="Vina≈ôstv√≠" class="border p-3 rounded-lg w-full transition-colors focus:ring-2 focus:ring-red-500 outline-none" required>
                    
                    <select id="input-classification" class="border p-3 rounded-lg w-full transition-colors focus:ring-2 focus:ring-red-500 outline-none">
                        <option value="">-- Klasifikace --</option>
                        <option value="Moravsk√© zemsk√© v√≠no">Moravsk√© zemsk√© v√≠no</option>
                        <option value="Pozdn√≠ sbƒõr">Pozdn√≠ sbƒõr</option>
                        <option value="V√Ωbƒõr z hrozn≈Ø">V√Ωbƒõr z hrozn≈Ø</option>
                        <option value="V√Ωbƒõr z bobul√≠">V√Ωbƒõr z bobul√≠</option>
                        <option value="Kabinetn√≠ v√≠no">Kabinetn√≠ v√≠no</option>
                        <option value="Jakostn√≠ v√≠no">Jakostn√≠ v√≠no</option>
                        <option value="VOC">VOC</option>
                        <option value="Lik√©rov√© v√≠no">Lik√©rov√© v√≠no</option>
                        <option value="Sl√°mov√© v√≠no">Sl√°mov√© v√≠no</option>
                        <option value="Ledov√© v√≠no">Ledov√© v√≠no</option>
                    </select>

                    <select id="input-sweetness" class="border p-3 rounded-lg w-full transition-colors focus:ring-2 focus:ring-red-500 outline-none">
                        <option value="">-- Cukernatost --</option>
                        <option value="Such√©">Such√©</option>
                        <option value="Polosuch√©">Polosuch√©</option>
                        <option value="Polosladk√©">Polosladk√©</option>
                        <option value="Sladk√©">Sladk√©</option>
                    </select>

                    <input type="text" id="input-alcohol" placeholder="Alkohol (nap≈ô. 12,5 %)" class="border p-3 rounded-lg w-full transition-colors focus:ring-2 focus:ring-red-500 outline-none">
                    <input type="text" id="input-origin" placeholder="P≈Øvod (podoblast, obec)" class="border p-3 rounded-lg w-full transition-colors focus:ring-2 focus:ring-red-500 outline-none">
                    
                    <div class="md:col-span-2">
                        <textarea id="input-pairing" placeholder="P√°rov√°n√≠ s j√≠dlem nebo pozn√°mka" class="border p-3 rounded-lg w-full h-20 transition-colors focus:ring-2 focus:ring-red-500 outline-none"></textarea>
                    </div>

                    <div class="md:col-span-2">
                        <button type="submit" class="bg-red-700 text-white font-bold py-3 px-6 rounded-lg w-full hover:bg-red-800 transition shadow-md">
                            Ulo≈æit v√≠no do datab√°ze
                        </button>
                    </div>
                </form>
            </div>
            
            <div id="wine-loader" class="loader hidden"></div>
            <main id="wine-list" class="space-y-6"></main>
        </div>
    </div>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Konfigurace Firebase (vlo≈æena va≈°e)
        const firebaseConfig = {
            apiKey: "AIzaSyAn6jNCHyJNo194jOPMrate3vQ-sBQdsrk",
            authDomain: "amantesvinea.firebaseapp.com",
            databaseURL: "https://amantesvinea-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "amantesvinea",
            storageBucket: "amantesvinea.firebasestorage.app",
            messagingSenderId: "314403202533",
            appId: "1:314403202533:web:db9eb6416a8710a837bb0c"
        };

        // API Kl√≠ƒç pro Gemini (dopln√≠ se prost≈ôed√≠m)
        const apiKey = ""; 

        let app, db;

        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
        } catch (e) {
            showError("Chyba inicializace Firebase: " + e.message);
        }

        // --- Promƒõnn√© ---
        let currentTastingId = null;
        const homePage = document.getElementById('home');
        const detailPage = document.getElementById('detail');
        const tastingListContainer = document.getElementById('tasting-list');
        const wineListContainer = document.getElementById('wine-list');
        const detailTitle = document.getElementById('detail-title');
        const varietyInfoContainer = document.getElementById('variety-info-container');
        const homeLoader = document.getElementById('home-loader');
        const wineLoader = document.getElementById('wine-loader');
        const errorMsg = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        const toggleAddWineBtn = document.getElementById('toggle-add-wine-btn');
        const addWineClosedMsg = document.getElementById('add-wine-closed-msg');
        const addWineContainer = document.getElementById('add-wine-container');
        const cameraInput = document.getElementById('cameraInput');
        const scanOverlay = document.getElementById('scan-overlay');

        function showError(msg) {
            errorText.innerText = msg;
            errorMsg.style.display = 'block';
            console.error(msg);
            setTimeout(() => { errorMsg.style.display = 'none'; }, 6000);
        }

        // --- GEMINI VISION LOGIKA ---
        
        // Funkce pro vol√°n√≠ Gemini API
        async function analyzeLabelWithGemini(base64Image, mimeType) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const prompt = `Analyzuj tuto etiketu v√≠na. Vra≈• mi POUZE validn√≠ JSON objekt (≈æ√°dn√Ω markdown, ≈æ√°dn√Ω text okolo) s tƒõmito kl√≠ƒçi:
            {
                "name": "Pln√Ω n√°zev v√≠na vƒçetnƒõ odr≈Ødy a roƒçn√≠ku",
                "winery": "Jm√©no vina≈ôstv√≠",
                "classification": "Jedna z hodnot: Moravsk√© zemsk√© v√≠no, Pozdn√≠ sbƒõr, V√Ωbƒõr z hrozn≈Ø, Kabinetn√≠ v√≠no, Jakostn√≠ v√≠no, VOC, Lik√©rov√© v√≠no, Sl√°mov√© v√≠no, Ledov√© v√≠no. Pokud nev√≠≈°, nechej pr√°zdn√©.",
                "sweetness": "Jedna z hodnot: Such√©, Polosuch√©, Polosladk√©, Sladk√©. Pokud nen√≠ uvedeno, zkus odhadnout dle typu, jinak pr√°zdn√©.",
                "alcohol": "Obsah alkoholu (nap≈ô. 12,5 %)",
                "origin": "Oblast, podoblast nebo obec",
                "pairing": "Kr√°tk√Ω tip na j√≠dlo"
            }`;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inline_data: { mime_type: mimeType, data: base64Data } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json"
                }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error?.message || `API Error: ${response.status}`);
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!text) throw new Error("AI nevr√°tila ≈æ√°dn√Ω text.");
            
            try {
                return JSON.parse(text);
            } catch (e) {
                // Fallback pro p≈ô√≠pad, ≈æe model i p≈ôes instrukce vr√°t√≠ markdown
                const cleanText = text.replace(/```json|```/g, '').trim();
                return JSON.parse(cleanText);
            }
        }

        // Obsluha inputu kamery
        let base64Data = "";
        
        cameraInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Zobrazit overlay
            scanOverlay.classList.remove('hidden');

            try {
                // P≈ôevod na Base64
                const reader = new FileReader();
                reader.readAsDataURL(file);
                
                await new Promise((resolve, reject) => {
                    reader.onload = () => {
                        base64Data = reader.result.split(',')[1];
                        resolve();
                    };
                    reader.onerror = reject;
                });

                // Vol√°n√≠ AI
                const wineData = await analyzeLabelWithGemini(base64Data, file.type);
                
                // Naplnƒõn√≠ formul√°≈ôe
                populateForm(wineData);
                
            } catch (error) {
                showError("Nepoda≈ôilo se naƒç√≠st etiketu: " + error.message);
            } finally {
                scanOverlay.classList.add('hidden');
                cameraInput.value = ''; // Reset, aby ≈°lo vyfotit znovu stejn√Ω soubor
            }
        });

        function populateForm(data) {
            if (data.name) document.getElementById('input-name').value = data.name;
            if (data.winery) document.getElementById('input-winery').value = data.winery;
            if (data.alcohol) document.getElementById('input-alcohol').value = data.alcohol;
            if (data.origin) document.getElementById('input-origin').value = data.origin;
            if (data.pairing) document.getElementById('input-pairing').value = data.pairing;

            setSelectValue('input-classification', data.classification);
            setSelectValue('input-sweetness', data.sweetness);

            // Zv√Ωraznƒõn√≠ formul√°≈ôe
            const form = document.getElementById('add-wine-form');
            form.classList.add('ring-4', 'ring-green-300', 'transition', 'duration-500');
            setTimeout(() => form.classList.remove('ring-4', 'ring-green-300'), 1500);
        }

        function setSelectValue(id, value) {
            const select = document.getElementById(id);
            if (!value || !select) return;
            const normValue = value.toLowerCase().trim();
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value.toLowerCase().trim() === normValue) {
                    select.selectedIndex = i;
                    break;
                }
            }
        }

        // --- Zbytek logiky (Firebase, UI) ---

        function isRegistrationOpen(dateString) {
            const eventDate = new Date(dateString);
            eventDate.setHours(0, 0, 0, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return today < eventDate;
        }

        toggleAddWineBtn.addEventListener('click', () => {
            if (addWineContainer.classList.contains('hidden')) {
                addWineContainer.classList.remove('hidden');
                toggleAddWineBtn.innerHTML = `Zav≈ô√≠t formul√°≈ô`;
                toggleAddWineBtn.classList.replace('bg-green-600', 'bg-gray-500');
                toggleAddWineBtn.classList.replace('hover:bg-green-700', 'hover:bg-gray-600');
            } else {
                addWineContainer.classList.add('hidden');
                toggleAddWineBtn.innerHTML = `P≈ôidat vlastn√≠ vzorek`;
                toggleAddWineBtn.classList.replace('bg-gray-500', 'bg-green-600');
                toggleAddWineBtn.classList.replace('hover:bg-gray-600', 'hover:bg-green-700');
            }
        });

        function loadTastings() {
            homeLoader.classList.remove('hidden');
            const tastingsRef = ref(db, 'tastings');

            onValue(tastingsRef, (snapshot) => {
                tastingListContainer.innerHTML = '';
                const data = snapshot.val();
                
                if (!data) {
                    tastingListContainer.innerHTML = '<p class="text-center p-4">≈Ω√°dn√° data v datab√°zi.</p>';
                    homeLoader.classList.add('hidden');
                    return;
                }

                const tastings = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                tastings.sort((a, b) => new Date(b.date) - new Date(a.date));

                tastings.forEach(tasting => {
                    const dayInfo = getTimeRemaining(tasting.date);
                    const firstTwoWords = tasting.theme.split(' ').slice(0, 2).join('+');
                    const card = document.createElement('div');
                    card.className = "tasting-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer";
                    card.onclick = () => showDetailPage(tasting);
                    card.innerHTML = `
                        <img src="${tasting.image}" alt="${tasting.theme}" class="w-full h-52 object-cover" 
                             onerror="this.onerror=null;this.src='https://placehold.co/600x400/374151/ffffff?text=${firstTwoWords}';">
                        <div class="p-6">
                            <p class="text-sm font-semibold mb-2 ${dayInfo.includes('Prob√≠h√°') || dayInfo.includes('Z√≠tra') ? 'text-red-600' : 'text-gray-500'}">
                                ${dayInfo} &middot; ${tasting.displayDate}
                            </p>
                            <h2 class="text-2xl font-bold text-gray-900 mt-1 mb-3">${tasting.theme}</h2>
                            <p class="text-gray-600 mb-5">${tasting.description}</p>
                            <div class="flex justify-between items-center text-sm font-medium border-t pt-4">
                                <span class="text-gray-500">Otev≈ô√≠t degustaci</span>
                                <span class="text-red-700 font-bold hover:text-red-900 transition-colors">&rarr;</span>
                            </div>
                        </div>`;
                    tastingListContainer.appendChild(card);
                });
                homeLoader.classList.add('hidden');
            }, (error) => {
                let msg = "Chyba p≈ôi naƒç√≠t√°n√≠ dat: " + error.message;
                if (error.code === 'PERMISSION_DENIED') msg = "P≈ô√≠stup odep≈ôen! Nastavte pravidla v konzoli.";
                showError(msg);
                homeLoader.classList.add('hidden');
            });
        }

        window.showDetailPage = function(tasting) {
            currentTastingId = tasting.id;
            detailTitle.textContent = tasting.theme;
            errorMsg.style.display = 'none';
            
            // Logika tlaƒç√≠tek a formul√°≈ôe
            addWineContainer.classList.add('hidden'); // V≈ædy schovat formul√°≈ô p≈ôi startu
            
            if (isRegistrationOpen(tasting.date)) {
                toggleAddWineBtn.classList.remove('hidden');
                addWineClosedMsg.classList.add('hidden');
                toggleAddWineBtn.innerHTML = "P≈ôidat vlastn√≠ vzorek";
                toggleAddWineBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                toggleAddWineBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                toggleAddWineBtn.classList.add('hidden');
                addWineClosedMsg.classList.remove('hidden');
            }

            varietyInfoContainer.innerHTML = '';
            if (tasting.varietyInfo) {
                varietyInfoContainer.classList.remove('hidden');
                let html = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">`;
                tasting.varietyInfo.forEach(info => {
                    html += `<div class="variety-info p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${info.title}</h3>
                        <p class="text-sm text-gray-700 mb-2"><strong>P≈Øvod:</strong> ${info.origin}</p>
                        <p class="text-sm text-gray-700"><strong>Charakteristika:</strong> ${info.characteristics}</p>
                    </div>`;
                });
                html += `</div>`;
                varietyInfoContainer.innerHTML = html;
            } else {
                varietyInfoContainer.classList.add('hidden');
            }

            homePage.classList.add('hidden');
            detailPage.classList.remove('hidden');
            window.scrollTo(0, 0);

            wineListContainer.innerHTML = '';
            wineLoader.classList.remove('hidden');

            const winesRef = query(ref(db, 'wines'), orderByChild('tastingId'), equalTo(currentTastingId));

            onValue(winesRef, (snapshot) => {
                wineListContainer.innerHTML = '';
                const data = snapshot.val();

                if (!data) {
                    wineListContainer.innerHTML = `<p class="text-center text-gray-500 italic p-8">Zat√≠m nebyla p≈ôid√°na ≈æ√°dn√° v√≠na.</p>`;
                    wineLoader.classList.add('hidden');
                    return;
                }

                const wines = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                wines.sort((a, b) => (a.createdAt || '').localeCompare(b.createdAt || ''));

                let index = 1;
                wines.forEach((wine) => {
                    const wineCard = document.createElement('div');
                    wineCard.className = "bg-white rounded-xl shadow-lg p-6 border-l-8 border-red-700 relative group";
                    wineCard.innerHTML = `
                        <h3 class="text-2xl font-extrabold text-gray-900 mb-3"><span class="text-red-700">${index}.</span> ${wine.name}</h3>
                        <p class="text-lg text-gray-700 font-semibold mb-4">${wine.winery}</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-y-4 gap-x-6 text-sm">
                            <div><p class="text-gray-500">Klasifikace</p><p class="font-bold text-gray-800">${wine.classification || '-'}</p></div>
                            <div><p class="text-gray-500">Cukernatost</p><p class="font-bold text-gray-800">${wine.sweetness || '-'}</p></div>
                            <div><p class="text-gray-500">Alkohol</p><p class="font-bold text-gray-800">${wine.alcohol || '-'}</p></div>
                            <div class="md:col-span-1"><p class="text-gray-500">P≈Øvod</p><p class="font-bold text-gray-800">${wine.origin || '-'}</p></div>
                        </div>
                        ${wine.pairing ? `<div class="mt-6 p-4 bg-gray-50 rounded-lg border-l-4 border-gray-300"><p class="text-gray-500 font-medium">Pozn√°mka / P√°rov√°n√≠</p><p class="font-medium text-gray-800">${wine.pairing}</p></div>` : ''}`;
                    wineListContainer.appendChild(wineCard);
                    index++;
                });
                wineLoader.classList.add('hidden');
            }, (error) => {
                 showError("Chyba p≈ôi naƒç√≠t√°n√≠ v√≠n: " + error.message);
                 wineLoader.classList.add('hidden');
            });
        }

        document.getElementById('add-wine-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentTastingId) return;

            const submitBtn = e.target.querySelector('button');
            const originalText = submitBtn.innerText;
            submitBtn.innerText = "Ukl√°d√°m...";
            submitBtn.disabled = true;

            const newWine = {
                tastingId: currentTastingId,
                name: document.getElementById('input-name').value,
                winery: document.getElementById('input-winery').value,
                classification: document.getElementById('input-classification').value,
                sweetness: document.getElementById('input-sweetness').value,
                alcohol: document.getElementById('input-alcohol').value,
                origin: document.getElementById('input-origin').value,
                pairing: document.getElementById('input-pairing').value,
                createdAt: new Date().toISOString()
            };

            const newWineRef = push(ref(db, 'wines'));
            set(newWineRef, newWine)
                .then(() => {
                    e.target.reset();
                    alert("V√≠no √∫spƒõ≈°nƒõ p≈ôid√°no!");
                    addWineContainer.classList.add('hidden');
                    toggleAddWineBtn.innerHTML = `P≈ôidat vlastn√≠ vzorek`;
                    toggleAddWineBtn.classList.replace('bg-gray-500', 'bg-green-600');
                    toggleAddWineBtn.classList.replace('hover:bg-gray-600', 'hover:bg-green-700');
                })
                .catch((error) => {
                    showError("Chyba p≈ôi ukl√°d√°n√≠: " + error.message);
                })
                .finally(() => {
                    submitBtn.innerText = originalText;
                    submitBtn.disabled = false;
                });
        });

        document.getElementById('back-button').addEventListener('click', () => {
            detailPage.classList.add('hidden');
            homePage.classList.remove('hidden');
            errorMsg.style.display = 'none';
            currentTastingId = null;
        });

        function getTimeRemaining(dateString) {
            const eventDate = new Date(dateString);
            eventDate.setHours(0, 0, 0, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diffTime = eventDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < -3) return 'Probƒõhlo'; 
            if (diffDays <= 0) return 'Pr√°vƒõ prob√≠h√°';
            if (diffDays === 1) return 'Z√≠tra!';
            if (diffDays < 7) return `Za ${diffDays} dny`;
            if (diffDays <= 30) return `Za ${diffDays} dn√≠`;
            return `Za ${Math.floor(diffDays / 30)} mƒõs√≠c≈Ø`;
        }

        loadTastings();
    </script>
</body>
</html>